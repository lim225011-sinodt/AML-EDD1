# AML-EDD反洗钱数据库SQL程序使用说明

## 概述

本目录包含了完整的AML-EDD反洗钱数据库建表和数据生成程序，符合农业银行300号文件接口格式要求。

## 文件清单

| 文件名 | 功能描述 |
|--------|----------|
| `AML300_数据库建表和数据生成程序.sql` | 主SQL程序，包含建表语句和测试数据生成 |
| `test_sql_validation.py` | 完整的SQL验证测试程序 |
| `run_sql_test.py` | 快速SQL验证脚本 |
| `database_config.py` | 数据库配置文件 |
| `SQL程序使用说明.md` | 本说明文档 |

## 功能特性

### 数据规模
- ✅ **个人客户**: 1000条完整记录
- ✅ **企业客户**: 100条完整记录
- ✅ **账户信息**: 800-1200个账户
- ✅ **交易记录**: 10000条测试交易
- ✅ **风险等级**: 最新+历史风险评级

### 技术特性
- ✅ **UTF-8编码**: 完全支持简体中文
- ✅ **300号文件格式**: 严格遵循农业银行标准
- ✅ **模拟数据**: 包含中文姓名、地址、公司信息
- ✅ **外键约束**: 完整的数据关系约束
- ✅ **索引优化**: 针对查询性能优化

## 环境要求

### 软件要求
- **MySQL**: 8.0+ （推荐8.0.25+）
- **Python**: 3.8+ （如需运行验证程序）
- **字符集**: 必须支持UTF-8MB4

### Python依赖（验证程序需要）
```bash
pip install mysql-connector-python
```

## 使用方法

### 方法一：直接在MySQL中执行SQL

1. **启动MySQL服务**
```bash
# Windows
net start mysql

# Linux/Mac
sudo systemctl start mysql
```

2. **登录MySQL**
```bash
mysql -u root -p
```

3. **执行SQL程序**
```sql
-- 方法1: 在MySQL命令行中
source AML300_数据库建表和数据生成程序.sql;

-- 方法2: 或使用系统命令
mysql -u root -p < AML300_数据库建表和数据生成程序.sql
```

### 方法二：使用Python验证程序

1. **快速验证**（推荐首先执行）
```bash
python run_sql_test.py
```

2. **完整验证测试**
```bash
# 修改数据库配置（如果需要）
vim database_config.py

# 执行完整验证
python test_sql_validation.py
```

## 数据库结构

### 核心表结构

| 表名 | 说明 | 主要字段 |
|------|------|----------|
| `tb_bank` | 机构对照表 | Bank_code1, Bank_name, Bord_type |
| `tb_cst_pers` | 个人客户信息 | Cst_no, Acc_name, Id_no, Contact1 |
| `tb_cst_unit` | 企业客户信息 | Cst_no, Acc_name, License, Industry |
| `tb_acc` | 账户主档 | Self_acc_no, Card_no, Acc_type, Cst_no |
| `tb_acc_txn` | 交易记录 | Date, Time, Self_acc_no, Org_amt, Cur |
| `tb_risk_new` | 最新风险等级 | Cst_no, Risk_code, Time, Norm |

### 关键特性

1. **中文字段注释**: 所有字段都包含中文注释
2. **数据关系**: 完整的外键约束和索引
3. **业务类型**: 支持15种不同的业务类型
4. **多币种**: 支持CNY、USD、EUR、JPY、GBP
5. **风险分级**: 高、中高、中、低四级风险等级

## 验证和测试

### 快速验证检查项

运行快速验证脚本会检查：

- [x] 依赖项是否完整
- [x] SQL语法是否正确
- [x] MySQL连接是否正常
- [x] SQL结构是否完整
- [x] 测试计划是否生成

### 完整验证检查项

运行完整验证测试会检查：

- [x] MySQL版本兼容性
- [x] 字符集支持（UTF-8MB4）
- [x] 表结构创建
- [x] 数据生成完整性
- [x] 外键约束有效性
- [x] 数据质量标准
- [x] 性能指标

### 预期数据量

| 数据类型 | 预期数量 | 允许范围 |
|----------|----------|----------|
| 个人客户 | 1000 | 900-1100 |
| 企业客户 | 100 | 90-110 |
| 账户 | ~1000 | 800-1200 |
| 交易记录 | 10000 | 9000-11000 |
| 最新风险等级 | ~1100 | 1000-1200 |
| 历史风险等级 | ~400 | 300-600 |

## 数据质量保证

### 个人客户数据
- ✅ 真实中文姓名（使用常见姓氏+名字）
- ✅ 有效身份证号码（18位，含校验码）
- ✅ 中国手机号码格式
- ✅ 完整地址信息（省市区详细地址）
- ✅ 合理职业和收入范围

### 企业客户数据
- ✅ 统一社会信用代码（18位）
- ✅ 真实企业名称格式
- ✅ 法定代表人姓名
- ✅ 行业分类和注册资本
- ✅ 营业执照信息

### 交易数据
- ✅ 最近90天内的交易时间
- ✅ 合理的交易金额分布
- ✅ 多种币种支持
- ✅ 不同的交易方式和用途
- ✅ IP地址和设备信息

## 性能指标

### 执行性能
- **总执行时间**: < 5分钟
- **建表时间**: < 30秒
- **数据生成**: 3-4分钟
- **索引创建**: < 30秒

### 资源占用
- **内存使用**: < 1GB
- **存储空间**: ~50MB
- **CPU使用**: 中等

## 故障排除

### 常见问题

1. **连接失败**
```
错误: Access denied for user 'root'@'localhost'
解决: 检查MySQL用户名和密码
```

2. **字符集问题**
```
错误: Incorrect string value
解决: 确保MySQL使用utf8mb4字符集
```

3. **权限问题**
```
错误: Access denied for user
解决: 确保MySQL用户有CREATE、INSERT权限
```

4. **内存不足**
```
错误: Out of memory
解决: 增加MySQL内存配置或分批执行
```

### 调试方法

1. **查看MySQL日志**
```sql
SHOW VARIABLES LIKE 'log_error';
```

2. **检查表状态**
```sql
SHOW TABLE STATUS;
```

3. **验证数据**
```sql
SELECT COUNT(*) FROM tb_cst_pers;
SELECT COUNT(*) FROM tb_acc_txn;
```

## 安全注意事项

### 数据安全
- ✅ 所有测试数据均为虚构
- ✅ 身份证号、手机号为随机生成
- ✅ 不包含任何真实客户信息
- ✅ 符合数据脱敏要求

### 数据库安全
- 🔒 建议使用专用测试数据库
- 🔒 不要在生产环境直接执行
- 🔒 定期清理测试数据
- 🔒 设置适当的访问权限

## 扩展和定制

### 修改数据量

如需调整数据生成量，修改SQL文件中的相关参数：

```sql
-- 修改个人客户数量（当前1000条）
SELECT 1 UNION SELECT 2 ... UNION SELECT 1000

-- 修改企业客户数量（当前100条）
SELECT 1 UNION SELECT 2 ... UNION SELECT 100

-- 修改交易记录数量（存储过程中）
WHILE i <= 10000 DO
```

### 添加新字段

1. 在相应表的CREATE TABLE语句中添加字段
2. 更新INSERT语句包含新字段
3. 重新运行验证测试

### 自定义业务规则

修改数据生成逻辑中的随机分布和业务规则。

## 技术支持

### 日志文件
- `sql_validation.log`: 详细验证日志
- `validation_report.md`: 验证报告

### 联系信息
- 版本: v1.0
- 创建时间: 2025-11-09
- 适用于: AML-EDD v0.6

## 更新记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2025-11-09 | 初始版本，支持完整的300号文件格式 |

---

**注意**: 本程序仅用于开发和测试环境，生产环境使用前请进行充分的验证和安全评估。